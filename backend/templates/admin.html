<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç®¡ç†å‘˜åå° - å‘ç¥¨æ€»è§ˆ</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .table td, .table th {
            vertical-align: middle;
            font-size: 0.8rem;
        }
        .btn-group-sm > .btn, .btn-sm {
            padding: 0.2rem 0.5rem;
            font-size: 0.75rem;
        }
        .text-decoration-none {
            text-decoration: none !important;
        }
    </style>
</head>
<body>
    <div class="container-fluid mt-4">
        <div class="d-flex justify-content-between align-items-center mb-4 border-bottom pb-3">
            <h1 class="mb-0">ğŸ¢ ç®¡ç†å‘˜åå° - å‘ç¥¨æ€»è§ˆ</h1>
            <div>
                <a href="{{ url_for('admin_user_management') }}" class="btn btn-info me-2">ğŸ‘¥ ç”¨æˆ·ç®¡ç†</a>
                <a href="{{ url_for('logout') }}" class="btn btn-danger">ğŸšª é€€å‡ºç™»å½•</a>
            </div>
        </div>
        
        <form method="POST" action="{{ url_for('admin_batch_action') }}" id="batch_action_form" onsubmit="return handleBatchAction(event);">
            <div class="d-flex justify-content-between mb-3">
                <div class="d-flex">
                    <select name="action" id="batch_action_select" class="form-select form-select-sm me-2" style="width: auto;">
                        <option value="">é€‰æ‹©æ‰¹é‡æ“ä½œ...</option>
                        <option value="set_reimbursed">æ‰¹é‡æ ‡è®°ä¸ºå·²æŠ¥é”€</option>
                        <option value="set_pending">æ‰¹é‡æ ‡è®°ä¸ºæœªæŠ¥é”€</option>
                        <option value="mark_pay_to_seller">æ‰¹é‡æ ‡è®°ä¸ºå¯¹å…¬è½¬è´¦</option>
                        <option value="unmark_pay_to_seller">æ‰¹é‡å–æ¶ˆå¯¹å…¬è½¬è´¦</option>
                        <option value="delete_batch">æ‰¹é‡åˆ é™¤</option>
                    </select>
                    <button type="submit" class="btn btn-sm btn-secondary">æ‰§è¡Œé€‰ä¸­æ“ä½œ</button>
                </div>
                
                <a href="{{ url_for('admin_export') }}" class="btn btn-success btn-sm">ğŸ“¦ å¯¼å‡ºæ‰€æœ‰æ•°æ® (.zip)</a>
            </div>
        </form>
        
        <div class="table-responsive">
            <table class="table table-sm table-striped table-hover align-middle">
                <thead class="table-dark sticky-top">
                    <tr>
                        <th scope="col">
                            <input type="checkbox" id="select_all">
                        </th>
                        <th scope="col">ID</th>
                        <th scope="col">æŠ¥é”€äºº</th>
                        <th scope="col">çŠ¶æ€</th>
                        <th scope="col">æŠ¥é”€çŠ¶æ€</th>
                        <th scope="col">å¯¹å…¬è½¬è´¦?</th> 
                        <th scope="col">å‘ç¥¨å·ç </th>
                        <th scope="col">å¼€ç¥¨æ—¥æœŸ</th>
                        <th scope="col">é¡¹ç›®åç§°</th>
                        <th scope="col">ä»·ç¨åˆè®¡</th>
                        <th scope="col">é”€å”®æ–¹</th>
                        <th scope="col">é™„ä»¶</th> 
                        <th scope="col" style="min-width: 100px;">å‘ç¥¨å¤‡æ³¨</th>
                        <th scope="col" style="min-width: 150px;">æ‰¹æ³¨</th>
                        <th scope="col">æ“ä½œ</th>
                    </tr>
                </thead>
                <tbody>
                    {% for invoice in invoices %}
                    <tr id="invoice-row-{{ invoice.id }}">
                        <td>
                            <input type="checkbox" name="invoice_ids" value="{{ invoice.id }}" form="batch_action_form">
                        </td>
                        <th scope="row">{{ invoice.id }}</th>
                        <td>{{ invoice.reimburser_name }}</td>
                        <td>
                            {% if invoice.status == 'å·²è¯†åˆ«' %}
                                <span class="badge bg-success">âœ… å·²è¯†åˆ«</span>
                            {% else %}
                                <span class="badge bg-danger">âŒ è¯†åˆ«å¤±è´¥</span>
                            {% endif %}
                        </td>
                        <td>
                            {% if invoice.reimbursement_status == 'å·²æŠ¥é”€' %}
                                <span class="badge bg-primary">{{ invoice.reimbursement_status }}</span>
                            {% else %}
                                <span class="badge bg-secondary">{{ invoice.reimbursement_status }}</span>
                            {% endif %}
                        </td>
                        <td>
                            {% if invoice.pay_to_seller == 1 %}
                                <span class="badge bg-warning text-dark">æ˜¯</span>
                            {% else %}
                                <span class="badge bg-secondary">å¦</span>
                            {% endif %}
                            
                            <form method="POST" action="{{ url_for('admin_mark_pay_to_seller', invoice_id=invoice.id) }}" class="d-inline ms-1">
                                <input type="hidden" name="state" value="{{ 1 if invoice.pay_to_seller == 0 else 0 }}">
                                <button type="submit" class="btn btn-sm btn-link p-0 text-decoration-none" title="åˆ‡æ¢å¯¹å…¬çŠ¶æ€">
                                    <span style="font-size: 1.2em;">ğŸ”„</span>
                                </button>
                            </form>
                        </td>
                        <td>{{ invoice.invoice_num or 'N/A' }}</td>
                        <td>{{ invoice.invoice_date or 'N/A' }}</td>
                        <td>{{ invoice.item_name or 'N/A' }}</td>
                        <td>{{ "Â¥ {:,.2f}".format(invoice.total_figuers) if invoice.total_figuers > 0 else 'N/A' }}</td>
                        <td>{{ invoice.seller_name or 'N/A' }}</td>
                        <td>
                            {% for attachment in invoice.attachments %}
                                <div class="d-flex align-items-center mb-1">
                                    <span class="text-secondary me-2" style="font-size: 0.7rem;">{{ attachment.new_file_name }}</span>
                                    <form method="POST" action="{{ url_for('admin_delete_attachment', attachment_id=attachment.id) }}" class="d-inline" onsubmit="return confirm('ç¡®è®¤åˆ é™¤è¯¥é™„ä»¶ï¼Ÿ');">
                                        <button type="submit" class="btn btn-sm btn-danger p-0 px-1" title="åˆ é™¤é™„ä»¶">x</button>
                                    </form>
                                </div>
                            {% endfor %}
                            
                            <form method="POST" action="{{ url_for('admin_add_attachment', invoice_id=invoice.id) }}" enctype="multipart/form-data" class="mt-2">
                                <input type="file" name="attachments" class="form-control form-control-sm" accept="image/*,.pdf,.doc,.docx" multiple required>
                                <button type="submit" class="btn btn-sm btn-info mt-1 w-100">ä¸Šä¼ é™„ä»¶</button>
                            </form>
                        </td>

                        <td style="min-width: 100px; max-width: 200px;">
                            <p class="text-break mb-0">
                                <small>{{ invoice.remarks or 'æ— å¤‡æ³¨' }}</small>
                            </p>
                        </td>
                        
                        <td style="min-width: 160px; max-width: 250px;">
                            <form method="POST" action="{{ url_for('update_comment', invoice_id=invoice.id) }}" class="d-flex align-items-center">
                                <input type="text" 
                                       class="form-control form-control-sm me-1" 
                                       name="user_comment" 
                                       value="{{ invoice.user_comment or '' }}" 
                                       placeholder="ç‚¹å‡»è¾“å…¥æ‰¹æ³¨">
                                <button type="submit" 
                                        class="btn btn-sm btn-outline-primary" 
                                        title="ä¿å­˜æ‰¹æ³¨"
                                        style="flex-shrink: 0;">
                                    ä¿å­˜
                                </button>
                            </form>
                        </td>
                        <td>
                            <form method="POST" action="{{ url_for('admin_delete_invoice', invoice_id=invoice.id) }}" onsubmit="return confirm('ç¡®è®¤åˆ é™¤è¯¥å‘ç¥¨åŠå…¶æ‰€æœ‰é™„ä»¶ï¼Ÿ');">
                                    <button type="submit" class="btn btn-sm btn-danger w-100">åˆ é™¤å‘ç¥¨</button>
                                </form>
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>

    </div>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        document.getElementById('select_all').addEventListener('change', function() {
            // é€‰æ‹©æ‰€æœ‰å…³è”åˆ°æ‰¹é‡è¡¨å•çš„å¤é€‰æ¡†
            let checkboxes = document.querySelectorAll('input[name="invoice_ids"][form="batch_action_form"]');
            checkboxes.forEach(checkbox => {
                checkbox.checked = this.checked;
            });
        });

        function handleBatchAction(event) {
            // è¿™ä¸ªå‡½æ•°åªç”¨äºæ‹¦æˆªæ‰¹é‡æ“ä½œè¡¨å•çš„æäº¤
            const action = document.getElementById('batch_action_select').value;
            if (!action) {
                alert('è¯·é€‰æ‹©ä¸€ä¸ªæ‰¹é‡æ“ä½œã€‚');
                event.preventDefault();
                return false;
            }
            
            // é€‰æ‹©æ‰€æœ‰å…³è”åˆ°æ‰¹é‡è¡¨å•çš„å¤é€‰æ¡†
            const selectedCount = document.querySelectorAll('input[name="invoice_ids"][form="batch_action_form"]:checked').length;
            if (selectedCount === 0) {
                alert('è¯·è‡³å°‘é€‰æ‹©ä¸€å¼ å‘ç¥¨è¿›è¡Œæ“ä½œã€‚');
                event.preventDefault();
                return false;
            }

            const confirmMessage = `ã€è­¦å‘Šã€‘æ‚¨ç¡®å®šè¦å¯¹é€‰ä¸­çš„ ${selectedCount} å¼ å‘ç¥¨æ‰§è¡Œ "${action}" æ“ä½œå—ï¼Ÿ`;
            
            if (!confirm(confirmMessage)) {
                event.preventDefault();
                return false;
            }
            return true;
        }
    </script>
</body>
</html>